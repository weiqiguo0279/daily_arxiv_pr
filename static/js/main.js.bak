/**
 * Daily arXiv - å‰ç«¯ JavaScript
 */

// å…¨å±€å˜é‡
let currentPage = 1;
let currentCategory = '';
let allPapers = [];

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
    loadStats();
    
    // åŠ è½½è¶‹åŠ¿åˆ†æ
    loadAnalysis();
    
    // åŠ è½½è®ºæ–‡åˆ—è¡¨
    loadPapers();
    
    // åŠ è½½ç±»åˆ«åˆ—è¡¨
    loadCategories();
    
    // ç»‘å®šäº‹ä»¶
    bindEvents();
    
    // æ»šåŠ¨åˆ°é¡¶éƒ¨æŒ‰é’®
    initScrollTop();
});

/**
 * åŠ è½½ç»Ÿè®¡ä¿¡æ¯
 */
async function loadStats() {
    try {
        const response = await fetch('/api/stats');
        const stats = await response.json();
        
        document.getElementById('papers-count').textContent = stats.papers_count;
        document.getElementById('summaries-count').textContent = stats.summaries_count;
        
        if (stats.last_update) {
            document.getElementById('last-update').textContent = stats.last_update;
        }
        
        // åŠ è½½åˆ†ææ•°æ®ä»¥è·å–æ›´å¤šç»Ÿè®¡
        const analysisResponse = await fetch('/api/analysis');
        if (analysisResponse.ok) {
            const analysis = await analysisResponse.json();
            const keywords = analysis.keywords || [];
            const categories = analysis.statistics?.category_distribution || {};
            
            document.getElementById('keywords-count').textContent = keywords.length;
            document.getElementById('categories-count').textContent = Object.keys(categories).length;
        }
    } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
    }
}

/**
 * åŠ è½½è¶‹åŠ¿åˆ†æ
 */
async function loadAnalysis() {
    try {
        const response = await fetch('/api/analysis');
        const analysis = await response.json();
        
        // åŠ è½½è¯äº‘å›¾
        loadWordcloud();
        
        // åŠ è½½ LLM åˆ†æå†…å®¹
        const llmAnalysis = analysis.llm_analysis || {};
        
        // ç ”ç©¶çƒ­ç‚¹
        const hotspotsContent = llmAnalysis.hotspots_html || llmAnalysis.hotspots || 'æš‚æ— æ•°æ®';
        document.getElementById('hotspots-content').innerHTML = hotspotsContent;
        
        // æŠ€æœ¯è¶‹åŠ¿
        const trendsContent = llmAnalysis.trends_html || llmAnalysis.trends || 'æš‚æ— æ•°æ®';
        document.getElementById('trends-content').innerHTML = trendsContent;
        
        // æœªæ¥æ–¹å‘
        const futureContent = llmAnalysis.future_directions_html || llmAnalysis.future_directions || 'æš‚æ— æ•°æ®';
        document.getElementById('future-content').innerHTML = futureContent;
        
        // åˆ›æ–°æƒ³æ³•
        const ideasContent = llmAnalysis.research_ideas_html || llmAnalysis.research_ideas || 'æš‚æ— æ•°æ®';
        document.getElementById('ideas-content').innerHTML = ideasContent;
        
    } catch (error) {
        console.error('åŠ è½½è¶‹åŠ¿åˆ†æå¤±è´¥:', error);
        showError('wordcloud-section', 'åŠ è½½è¶‹åŠ¿åˆ†æå¤±è´¥');
    }
}

/**
 * åŠ è½½è¯äº‘å›¾
 */
async function loadWordcloud() {
    try {
        const response = await fetch('/api/wordcloud');
        const data = await response.json();
        
        const container = document.getElementById('wordcloud-section');
        
        if (data.url) {
            container.innerHTML = `
                <img src="${data.url}" alt="è¯äº‘å›¾" class="img-fluid">
                <p class="text-muted mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    å­—ä½“å¤§å°åæ˜ å…³é”®è¯åœ¨è®ºæ–‡ä¸­å‡ºç°çš„é¢‘ç‡
                </p>
            `;
        } else {
            container.innerHTML = '<p class="text-muted">è¯äº‘å›¾æš‚ä¸å¯ç”¨</p>';
        }
    } catch (error) {
        console.error('åŠ è½½è¯äº‘å›¾å¤±è´¥:', error);
        document.getElementById('wordcloud-section').innerHTML = 
            '<p class="text-danger">åŠ è½½è¯äº‘å›¾å¤±è´¥</p>';
    }
}

/**
 * åŠ è½½è®ºæ–‡åˆ—è¡¨
 */
async function loadPapers(page = 1, category = '') {
    try {
        currentPage = page;
        currentCategory = category;
        
        const url = `/api/papers?page=${page}&per_page=10&category=${category}`;
        const response = await fetch(url);
        const data = await response.json();
        
        allPapers = data.papers;
        renderPapers(data.papers);
        renderPagination(data.total_pages, page);
        
    } catch (error) {
        console.error('åŠ è½½è®ºæ–‡åˆ—è¡¨å¤±è´¥:', error);
        showError('papers-list', 'åŠ è½½è®ºæ–‡åˆ—è¡¨å¤±è´¥');
    }
}

/**
 * æ¸²æŸ“è®ºæ–‡åˆ—è¡¨
 */
function renderPapers(papers) {
    const container = document.getElementById('papers-list');
    
    if (papers.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®ºæ–‡
            </div>
        `;
        return;
    }
    
    let html = '';
    papers.forEach((paper, index) => {
        html += renderPaperCard(paper, index);
    });
    
    container.innerHTML = html;
}

/**
 * æ¸²æŸ“å•ä¸ªè®ºæ–‡å¡ç‰‡
 */
function renderPaperCard(paper, index) {
    const authors = paper.authors.slice(0, 3).join(', ') + 
                   (paper.authors.length > 3 ? ' et al.' : '');
    
    const categories = paper.categories.map(cat => 
        `<span class="category-badge">${cat}</span>`
    ).join('');
    
    const publishDate = new Date(paper.published).toLocaleDateString('zh-CN');
    
    return `
        <div class="paper-card" data-paper-id="${paper.id}">
            <div class="paper-title">
                ${index + 1}. ${paper.title}
            </div>
            
            <div class="paper-meta">
                <div class="paper-meta-item">
                    <i class="fas fa-user"></i>
                    <span>${authors}</span>
                </div>
                <div class="paper-meta-item">
                    <i class="fas fa-calendar"></i>
                    <span>${publishDate}</span>
                </div>
            </div>
            
            <div class="paper-categories">
                ${categories}
            </div>
            
            <div class="paper-abstract">
                ${paper.abstract.substring(0, 300)}...
            </div>
            
            <div class="paper-actions">
                <a href="${paper.pdf_url}" target="_blank" class="btn-paper btn-pdf">
                    <i class="fas fa-file-pdf"></i>
                    æŸ¥çœ‹ PDF
                </a>
                <a href="${paper.entry_url}" target="_blank" class="btn-paper btn-details">
                    <i class="fas fa-external-link-alt"></i>
                    arXiv è¯¦æƒ…
                </a>
                <button class="btn-paper btn-details" onclick="showPaperDetail('${paper.id}')">
                    <i class="fas fa-info-circle"></i>
                    æŸ¥çœ‹æ€»ç»“
                </button>
            </div>
        </div>
    `;
}

/**
 * æ¸²æŸ“åˆ†é¡µ
 */
function renderPagination(totalPages, currentPage) {
    const container = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // ä¸Šä¸€é¡µ
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadPapers(${currentPage - 1}, '${currentCategory}'); return false;">
                ä¸Šä¸€é¡µ
            </a>
        </li>
    `;
    
    // é¡µç 
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadPapers(${i}, '${currentCategory}'); return false;">
                    ${i}
                </a>
            </li>
        `;
    }
    
    // ä¸‹ä¸€é¡µ
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadPapers(${currentPage + 1}, '${currentCategory}'); return false;">
                ä¸‹ä¸€é¡µ
            </a>
        </li>
    `;
    
    container.innerHTML = html;
}

/**
 * åŠ è½½ç±»åˆ«åˆ—è¡¨
 */
async function loadCategories() {
    try {
        const response = await fetch('/api/categories');
        const categories = await response.json();
        
        const select = document.getElementById('category-filter');
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.name;
            option.textContent = `${cat.name} (${cat.count})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('åŠ è½½ç±»åˆ«åˆ—è¡¨å¤±è´¥:', error);
    }
}

/**
 * æ˜¾ç¤ºè®ºæ–‡è¯¦æƒ…ï¼ˆåŒ…æ‹¬æ€»ç»“ï¼‰
 */
async function showPaperDetail(paperId) {
    try {
        const response = await fetch(`/api/papers/${paperId}`);
        const paper = await response.json();
        
        let summaryHtml = '';
        if (paper.summary) {
            const summary = paper.summary;
            summaryHtml = `
                <h5 class="mt-3">ğŸ“ è®ºæ–‡æ€»ç»“</h5>
                <div class="alert alert-info">
                    <p><strong>æ ¸å¿ƒåˆ›æ–°ç‚¹ï¼š</strong>${summary.key_innovation || 'æš‚æ— '}</p>
                    <p><strong>ä¸»è¦æ–¹æ³•ï¼š</strong>${summary.main_method || 'æš‚æ— '}</p>
                    <p><strong>ä¸»è¦ç»“æœï¼š</strong>${summary.main_results || 'æš‚æ— '}</p>
                    <p><strong>å±€é™æ€§ï¼š</strong>${summary.limitations || 'æš‚æ— '}</p>
                    <p><strong>ä¸€å¥è¯æ€»ç»“ï¼š</strong>${summary.one_sentence_summary || 'æš‚æ— '}</p>
                </div>
            `;
        } else {
            summaryHtml = '<p class="text-muted">è¯¥è®ºæ–‡æš‚æ— æ€»ç»“</p>';
        }
        
        // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºè¯¦æƒ…
        const modal = `
            <div class="modal fade" id="paperModal" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${paper.title}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p><strong>ä½œè€…ï¼š</strong>${paper.authors.join(', ')}</p>
                            <p><strong>å‘å¸ƒæ—¶é—´ï¼š</strong>${new Date(paper.published).toLocaleDateString('zh-CN')}</p>
                            <p><strong>ç±»åˆ«ï¼š</strong>${paper.categories.join(', ')}</p>
                            <hr>
                            <h5>æ‘˜è¦</h5>
                            <p>${paper.abstract}</p>
                            ${summaryHtml}
                        </div>
                        <div class="modal-footer">
                            <a href="${paper.pdf_url}" target="_blank" class="btn btn-danger">
                                <i class="fas fa-file-pdf me-2"></i>æŸ¥çœ‹ PDF
                            </a>
                            <a href="${paper.entry_url}" target="_blank" class="btn btn-primary">
                                <i class="fas fa-external-link-alt me-2"></i>arXiv è¯¦æƒ…
                            </a>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // ç§»é™¤æ—§çš„æ¨¡æ€æ¡†
        const oldModal = document.getElementById('paperModal');
        if (oldModal) {
            oldModal.remove();
        }
        
        // æ·»åŠ æ–°æ¨¡æ€æ¡†
        document.body.insertAdjacentHTML('beforeend', modal);
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modalElement = document.getElementById('paperModal');
        const bsModal = new bootstrap.Modal(modalElement);
        bsModal.show();
        
        // æ¨¡æ€æ¡†å…³é—­åç§»é™¤
        modalElement.addEventListener('hidden.bs.modal', function() {
            modalElement.remove();
        });
        
    } catch (error) {
        console.error('åŠ è½½è®ºæ–‡è¯¦æƒ…å¤±è´¥:', error);
        alert('åŠ è½½è®ºæ–‡è¯¦æƒ…å¤±è´¥');
    }
}

/**
 * ç»‘å®šäº‹ä»¶
 */
function bindEvents() {
    // ç±»åˆ«ç­›é€‰
    document.getElementById('category-filter').addEventListener('change', function(e) {
        loadPapers(1, e.target.value);
    });
    
    // æœç´¢
    let searchTimeout;
    document.getElementById('search-input').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchPapers(e.target.value);
        }, 500);
    });
}

/**
 * æœç´¢è®ºæ–‡
 */
function searchPapers(query) {
    if (!query.trim()) {
        renderPapers(allPapers);
        return;
    }
    
    const lowerQuery = query.toLowerCase();
    const filtered = allPapers.filter(paper => {
        return paper.title.toLowerCase().includes(lowerQuery) ||
               paper.abstract.toLowerCase().includes(lowerQuery) ||
               paper.authors.some(author => author.toLowerCase().includes(lowerQuery));
    });
    
    renderPapers(filtered);
}

/**
 * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
 */
function showError(containerId, message) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div class="error-message">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

/**
 * åˆå§‹åŒ–æ»šåŠ¨åˆ°é¡¶éƒ¨æŒ‰é’®
 */
function initScrollTop() {
    const scrollTop = document.getElementById('scroll-top');
    
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            scrollTop.classList.add('visible');
        } else {
            scrollTop.classList.remove('visible');
        }
    });
    
    scrollTop.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
}

/**
 * æ ¼å¼åŒ–æ—¥æœŸ
 */
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}
